Instructions for running the test cases
=======================================

1. Install the requirements and set up the environment
```bash
$ bash init.sh
$ source .venv/bin/activate
```

2. Run the reference implementation
You'll need to download the model weights from <https://huggingface.co/meta-llama/Llama-3.2-11B-Vision>.
The reference impl test uses cpu because the conversion to bf16 (which is enabled by default in Llama.build for cuda devices) causes precision issues.
```bash
$ torchrun test_ref_gen.py /path/to/Llama-3.2-11B-Vision/original
> initializing model parallel with size 1
> initializing ddp with size 1
> initializing pipeline with size 1
Loaded in 83.22 seconds
["Let's write a poem.", RawMediaItem(type='image', data=<_io.BytesIO object at 0x796f84a31530>), 'If I had to write a haiku for this one']
, it would be:.\nA dog on a skateboard.\nRolling down the street.\nWith a wagging tail.\nWhat would your haiku be?\nImage created with Midjourney AI. <OCR/> 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9

==================================

==================================
```

3. Run the HF implementation with and without the fix.
```bash
$ python test_hf_gen.py
Loading checkpoint shards: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:08<00:00,  1.62s/it]
<|begin_of_text|>Let's write a poem.<|image|>If I had to write a haiku for this one
, it would be:.\nA dog on a skateboard.\nRolling down the street.\nWith a smile on his face.\nWhat would your haiku be? Share it in the comments below!\nAnd don't forget to check out our website for more fun and creative content. We can't wait to hear from you!\nImage generated by Midjourney. Prompt: A dog on a skateboard, in the style of realistic animal portraits, street photography, street art, street
```

```bash
$ python test_hf_gen.py --fixed
Loading checkpoint shards: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:08<00:00,  1.62s/it]
<|begin_of_text|>Let's write a poem.<|image|>If I had to write a haiku for this one
, it would be:.\nA dog on a skateboard.\nRolling down the street.\nWith a wagging tail.\nWhat would your haiku be?\nImage created with Midjourney AI. <OCR/> 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9
```